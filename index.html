<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zama FHE Terminal - ƒê·∫•u Gi√° B·∫£o M·∫≠t</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* CSS Styles (Gi·ªØ nguy√™n) */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'VT323', monospace; background-color: #000000; color: #00ff00; min-height: 100vh; padding: 20px; font-size: 18px; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 40px; animation: fadeIn 1s ease-out; }
        h1 { font-size: 3em; margin-bottom: 5px; text-shadow: 0 0 5px #00ff00, 0 0 15px rgba(0, 255, 0, 0.8); }
        .subtitle { font-size: 1.2em; opacity: 0.9; }
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 30px; margin-bottom: 30px; }
        .card { background-color: #000000; border: 2px solid #00ff00; padding: 25px; box-shadow: 0 0 10px rgba(0, 255, 0, 0.5); animation: fadeInUp 1s ease-out; }
        .card h2 { margin-bottom: 20px; font-size: 1.8em; color: #ffff00; border-bottom: 1px dashed #00ff00; padding-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        input { width: 100%; padding: 12px; border: 1px solid #00ff00; background: #000; color: #00ff00; font-size: 1em; font-family: 'VT323', monospace; margin-bottom: 15px; caret-color: #ffff00; box-shadow: 0 0 5px rgba(0, 255, 0, 0.2); transition: border-color 0.2s; }
        input:focus { outline: none; border-color: #ffff00; box-shadow: 0 0 8px #ffff00; }
        button { background: #000; border: 2px solid #00ff00; padding: 12px 20px; color: #00ff00; font-size: 1.1em; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; transition: all 0.2s ease; font-family: 'VT323', monospace; letter-spacing: 1px; text-transform: uppercase; }
        button:hover { background: #00ff00; color: #000000; box-shadow: 0 0 15px #00ff00; }
        button:disabled { opacity: 0.4; cursor: not-allowed; background: #000; color: #00ff00; box-shadow: none; }
        .auction-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .info-item { background: #0a0a0a; padding: 15px; border: 1px solid #00ff00; text-align: center; }
        .info-label { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
        .info-value { font-size: 1.5em; font-weight: bold; color: #ffff00; }
        .wallet-status { padding: 15px; background: #0a0a0a; border: 1px dashed #00ff00; margin-bottom: 20px; text-align: left; }
        .fhe-badge { display: inline-block; background: #00ff00; color: #000; padding: 3px 8px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; margin-left: 10px; border: 1px solid #00ff00; box-shadow: 0 0 5px #00ff00; }
        .encrypted-badge { display: flex; align-items: center; gap: 10px; background: #111; padding: 10px; border: 1px solid #00ff00; margin-top: 10px; }
        .encrypted-badge::before { content: "üîí"; font-size: 1.2em; filter: drop-shadow(0 0 3px #00ff00); }
        .tx-monitor { grid-column: 1 / -1; }
        .tx-container { height: 300px; background: #0a0a0a; border: 1px solid #00ff00; overflow-y: auto; padding: 10px; line-height: 1.4; white-space: pre-wrap; position: relative; }
        .tx-container::-webkit-scrollbar { width: 8px; }
        .tx-container::-webkit-scrollbar-thumb { background: #00ff00; }
        .tx-container::-webkit-scrollbar-track { background: #0a0a0a; }
        .log-line { opacity: 0; animation: fadeIn 0.5s ease-out forwards; padding: 2px 0; }
        .log-time { color: #ffff00; margin-right: 10px; }
        .log-pending { color: orange; }
        .log-confirmed { color: #00ff00; }
        .log-failed { color: #ff0000; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { transform: translateY(0); } }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; background: #000; border: 2px solid; box-shadow: 0 0 10px; animation: slideInRight 0.4s ease; z-index: 1000; font-family: 'VT323', monospace; }
        .notification.success { border-color: #00ff00; box-shadow-color: rgba(0, 255, 0, 0.7); color: #00ff00; }
        .notification.error { border-color: #ff0000; box-shadow-color: rgba(255, 0, 0, 0.7); color: #ff0000; }
        .notification.info { border-color: #ffff00; box-shadow-color: rgba(255, 255, 0, 0.7); color: #ffff00; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .loading { display: inline-block; width: 1em; height: 1em; border: 0.15em solid rgba(0, 255, 0, 0.3); border-radius: 50%; border-top-color: #00ff00; animation: spin 1s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .reveal-btn { background: #ff0000; color: #fff; border-color: #ff0000; }
        .reveal-btn:hover { background: #ff5555; box-shadow: 0 0 15px #ff0000; }
        @media (min-width: 768px) { .main-grid { grid-template-columns: 2fr 3fr; } .tx-monitor { grid-column: 1 / 3; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>[SYSTEM ONLINE] ZAMA FHE AUCTION $</h1>
            <p class="subtitle">ƒê·∫•u gi√° b·∫£o m·∫≠t ho√†n to√†n ƒë·ªìng h√¨nh (FHE) - Sepolia Testnet Ready.</p>
        </header>

        <div class="main-grid">
            <div class="card wallet-section">
                <h2>> INIT WALLET SERVICE & FHE SDK</h2>
                <div class="wallet-status" id="walletStatus">
                    <p class="log-line log-info">[STATUS] Wallet: DISCONNECTED</p>
                    <p class="log-line log-info">[INFO] Target Network: **Sepolia (11155111)**</p>
                    <p class="log-line log-pending" id="fheStatus">[FHE SDK] Initializing FHE WASM files...</p>
                </div>
                <button id="connectBtn">
                    &gt; CONNECT & CHECK NETWORK
                </button>
            </div>

            <div class="card">
                <h2>> AUCTION DATA FEED (FHE PROTECTED)</h2>
                <div class="auction-info">
                    <div class="info-item">
                        <div class="info-label">Current Bid (Encrypted)</div>
                        <div class="info-value" id="currentBid">CIPHERTEXT</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Lead Bidder</div>
                        <div class="info-value" id="leadBidder">0x0000...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Min Bid Deposit</div>
                        <div class="info-value" id="minDepositValue">-- ETH</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Time Remaining</div>
                        <div class="info-value" id="timeLeft">--:--:--</div>
                    </div>
                </div>
                <button id="revealBtn" class="reveal-btn" disabled style="display: none;">
                    &gt; REQUEST DECRYPT AUCTION WINNER & REFUND $
                </button>
            </div>

            <div class="card" style="grid-column: 1 / -1;">
                <h2>> FHE BID SUBMISSION</h2>
                <label for="bidAmount" class="log-line">[INPUT] Enter Amount (ETH):</label>
                <input 
                    type="number" 
                    id="bidAmount" 
                    placeholder="ETH value (must meet min deposit)" 
                    step="0.001"
                    min="0"
                >
                <div class="encrypted-badge">
                    <span>S·ª≠ d·ª•ng **@zama-fhe/relayer-sdk** ƒë·ªÉ m√£ h√≥a **euint64** v√† t·∫°o proof client-side.</span>
                </div>
                <button id="bidBtn" disabled>
                    &gt; SUBMIT ENCRYPTED BID $ (Sepolia)
                </button>
            </div>

            <div class="card tx-monitor">
                <h2>> LIVE TRANSACTION LOG <span class="fhe-badge">FHEVM</span></h2>
                <div class="tx-container" id="txContainer">
                    <p class="log-line" style="animation-delay: 0.1s;"><span class="log-time">[00:00:00]</span> [CORE] System initialization complete. Awaiting wallet connection on Sepolia...</p>
                    <p class="log-line" style="animation-delay: 0.2s;"><span class="log-time">[00:00:01]</span> [FHE] Loading Zama SDK and Sepolia configuration...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <script src="https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.umd.cjs"></script> 
<script type="module">
        import { createInstance, SepoliaConfig } from 'https://esm.sh/@zama-fhe/relayer-sdk@latest';
        import { ethers } from 'https://esm.sh/ethers@latest';

        let instance = null;
        let signer = null;
        let provider = null;

        // Contract details
        const CONTRACT_ADDRESS = '0xe822e0cba6205b85cfaa48b0dd028fc74f17975f';
        const CONTRACT_ABI = [
            {
                "type": "function",
                "name": "add",
                "inputs": [
                    {"name": "a", "type": "externalEuint32", "internalType": "externalEuint32"},
                    {"name": "b", "type": "externalEuint32", "internalType": "externalEuint32"},
                    {"name": "inputProof", "type": "bytes", "internalType": "bytes"}
                ],
                "outputs": [{"name": "", "type": "euint32", "internalType": "euint32"}],
                "stateMutability": "nonpayable"
            },
            {
                "type": "function",
                "name": "subtract",
                "inputs": [
                    {"name": "a", "type": "externalEuint32", "internalType": "externalEuint32"},
                    {"name": "b", "type": "externalEuint32", "internalType": "externalEuint32"},
                    {"name": "inputProof", "type": "bytes", "internalType": "bytes"}
                ],
                "outputs": [{"name": "", "type": "euint32", "internalType": "euint32"}],
                "stateMutability": "nonpayable"
            }
        ];

        // Log function
        function updateLog(message, className = '') {
            const logDiv = document.getElementById('status-log');
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (className) p.className = className;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Update UI elements
        function updateStatus(id, text, className = '') {
            const elem = document.getElementById(id);
            elem.textContent = text;
            if (className) elem.className = className;
        }

        // Initialize FHE SDK
        async function initFheSdk() {
            try {
                updateLog('[FHE] Loading Zama SDK and Sepolia configuration...');
                const sdkInstance = await createInstance(SepoliaConfig);
                instance = sdkInstance;
                updateStatus('fhe-status', 'FHE SDK Ready', 'success');
                updateLog('[FHE SDK] Initialized successfully');
            } catch (err) {
                const errorMsg = 'Connection Failed: FHE SDK failed to initialize. Cannot proceed.';
                updateLog(`Initialization failed: ${err.message}`, 'error');
                updateStatus('fhe-status', errorMsg, 'error');
                console.error(errorMsg, err);
            }
        }

        // Connect Wallet
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                updateLog('MetaMask not found', 'error');
                return;
            }
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                signer = await provider.getSigner();
                const network = await provider.getNetwork();
                if (Number(network.chainId) !== 11155111) {
                    throw new Error('Please switch to Sepolia testnet (chainId: 11155111)');
                }
                const address = await signer.getAddress();
                updateStatus('wallet-status', `Wallet: CONNECTED (${address})`, 'success');
                updateLog(`Wallet connected: ${address}`);
            } catch (err) {
                updateLog(`Wallet connect failed: ${err.message}`, 'error');
            }
        }

        // Encrypt and Call Contract
        async function encryptAndCall(method, a, b) {
            if (!instance || !signer) {
                updateLog('SDK or wallet not ready', 'error');
                return;
            }
            try {
                updateLog(`Encrypting inputs for ${method}: ${a} ${method === 'add' ? '+' : '-'} ${b}`);
                const userAddress = await signer.getAddress();
                const buffer = instance.createEncryptedInput(CONTRACT_ADDRESS, userAddress);
                
                // Add inputs as euint32
                buffer.add32(BigInt(a));
                buffer.add32(BigInt(b));
                
                // Encrypt and generate proof/handles
                const ciphertexts = await buffer.encrypt();
                
                // Call contract
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                const tx = await contract[method](
                    ciphertexts.handles[0],  // a handle
                    ciphertexts.handles[1],  // b handle
                    ciphertexts.inputProof,  // proof
                    { gasLimit: 1000000 }
                );
                
                updateLog(`Transaction sent: ${tx.hash}`);
                const receipt = await tx.wait();
                updateLog(`${method} transaction confirmed: ${receipt.blockNumber}`);
                
                // For demo, assume output handle is from a view or event; here simulate public decrypt with a placeholder
                // In real: Extract euint32 handle from event/logs
                const outputHandle = '0x' + '0'.repeat(64);  // Placeholder; replace with actual from receipt.logs
                await decryptResult(outputHandle);
                
            } catch (err) {
                updateLog(`Call failed: ${err.message}`, 'error');
            }
        }

        // Decrypt Result (Public for demo)
        async function decryptResult(handle) {
            if (!instance) return;
            try {
                const decrypted = await instance.publicDecrypt([handle]);
                const value = Number(decrypted[0]);
                updateStatus('result-display', `Result: ${value}`);
                updateLog(`Decrypted result: ${value}`, 'success');
            } catch (err) {
                updateLog(`Decrypt failed: ${err.message}`, 'error');
                updateStatus('result-display', 'Decryption Failed');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initFheSdk();
            document.getElementById('connect-wallet').addEventListener('click', connectWallet);
            document.getElementById('calculate-add').addEventListener('click', () => {
                const a = parseInt(document.getElementById('input-a').value) || 0;
                const b = parseInt(document.getElementById('input-b').value) || 0;
                encryptAndCall('add', a, b);
            });
            document.getElementById('calculate-subtract').addEventListener('click', () => {
                const a = parseInt(document.getElementById('input-a').value) || 0;
                const b = parseInt(document.getElementById('input-b').value) || 0;
                encryptAndCall('subtract', a, b);
            });
        });

        // Handle chain changed
        if (window.ethereum) {
            window.ethereum.on('chainChanged', () => window.location.reload());
            window.ethereum.on('accountsChanged', () => window.location.reload());
        }
    </script>
    
</body>
</html>
