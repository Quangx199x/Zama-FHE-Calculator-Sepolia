<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FHE Auction DApp (Sepolia)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        #logContainer { 
            border: 1px solid #ccc; padding: 10px; height: 300px; 
            overflow-y: scroll; margin-top: 20px; background: #f9f9f9; 
            font-family: monospace; font-size: 14px; 
        }
        .log-line { margin: 2px 0; }
        .log-pending { color: orange; }
        .log-confirmed { color: green; }
        .log-failed { color: red; }
        #status { margin-top: 10px; font-weight: bold; }
        #notification { margin-top: 15px; font-weight: bold; }
        .notification-success { color: green; }
        .notification-error { color: red; }
        .notification-info { color: blue; }
    </style>
</head>
<body>
    <h1>FHE Auction DApp (Sepolia)</h1>

    <button id="connectWallet">Connect Wallet</button>
    <p id="walletAddress"></p>
    <p id="fheStatus">[FHE SDK] Not initialized.</p>

    <h2>Place Encrypted Bid</h2>
    <input type="number" id="bidAmount" placeholder="Bid amount in ETH">
    <button id="placeBid">Submit Encrypted Bid</button>

    <h2>Event Log</h2>
    <div id="logContainer"></div>

    <div id="notification"></div>

    <!-- ethers v6 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.4/dist/ethers.umd.min.js"></script>
    <!-- FHE Auction ABI -->
    <script src="./fheAuctionABI.js"></script>

    <script defer>
    // === Config ===
    const CONTRACT_ADDRESS = "0xe822e0cba6205b85cfaa48b0dd028fc74f17975f"; 
    const SEPOLIA_CHAIN_ID = 11155111;

    // === Global state ===
    let provider, signer, fhevmInstance, contract;

    // === Logging ===
    function logMessage(message, type = 'pending') {
        const logContainer = document.getElementById('logContainer');
        const logLine = document.createElement('div');
        logLine.className = `log-line log-${type}`;
        logLine.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logContainer.appendChild(logLine);
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    function showNotification(message, type = 'info') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification-${type}`;
    }

    // === Init FHE SDK ===
    async function initFhevmSdk() {
        const fheStatus = document.getElementById('fheStatus');
        try {
            fheStatus.textContent = '[FHE SDK] Loading SDK (ESM import)...';
            const mod = await import('https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js');
            const { initSDK, createInstance, SepoliaConfig } = mod;

            fheStatus.textContent = '[FHE SDK] Initializing WASM...';
            await initSDK();

            fheStatus.textContent = '[FHE SDK] Creating instance...';
            let sdkInstance = await createInstance({ ...SepoliaConfig, network: window.ethereum, chainId: SEPOLIA_CHAIN_ID });
            if (sdkInstance && typeof sdkInstance.init === 'function') {
                await sdkInstance.init();
            }

            fheStatus.textContent = '[FHE SDK] Public Key loaded. Ready.';
            fheStatus.className = 'log-line log-confirmed';
            logMessage('[FHE] SDK initialized successfully.', 'confirmed');
            return sdkInstance;
        } catch (error) {
            console.error("FHE SDK init failed:", error);
            fheStatus.textContent = '[FHE SDK] FAILED. See console.';
            fheStatus.className = 'log-line log-failed';
            logMessage(`[FATAL] FHE SDK Failed: ${error.message || error}`, 'failed');
            return null;
        }
    }

    // === Wallet connect ===
    async function connectWallet() {
        if (!window.ethereum) {
            showNotification("MetaMask not found", "error");
            return;
        }
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();

            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            document.getElementById('walletAddress').textContent = `Connected: ${accounts[0]}`;
            logMessage(`Wallet connected: ${accounts[0]}`, 'confirmed');

            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: '0xaa36a7' }]
            });

            fhevmInstance = await initFhevmSdk(window.ethereum);
            if (!fhevmInstance) throw new Error("FHE SDK init failed.");

            contract = new ethers.Contract(CONTRACT_ADDRESS, fheAuctionABI, signer);
            logMessage("Contract connected.", "confirmed");
        } catch (err) {
            console.error("Wallet connection failed:", err);
            logMessage(`[ERROR] ${err.message}`, "failed");
            showNotification("Wallet connection failed", "error");
        }
    }

    // === Place encrypted bid ===
    async function placeBid() {
        if (!fhevmInstance || !contract) {
            showNotification("Wallet & FHE SDK must be connected.", "error");
            return;
        }
        const bidInput = document.getElementById('bidAmount').value;
        if (!bidInput || bidInput <= 0) {
            showNotification("Enter a valid bid.", "error");
            return;
        }
        try {
            const bidAmountWei = ethers.parseEther(bidInput);
            logMessage(`Preparing bid ${bidInput} ETH (${bidAmountWei} wei)...`);

            const BID_DIV = ethers.toBigInt("1000000000");
            const bidAmountGweiBN = (bidAmountWei / BID_DIV);

            const MAX_UINT64 = (1n << 64n) - 1n;
            if (bidAmountGweiBN > MAX_UINT64) {
                showNotification("Bid too high for euint64", "error");
                return;
            }

            const buffer = await fhevmInstance.createEncryptedInput(CONTRACT_ADDRESS, signer.address);
            buffer.add64(bidAmountGweiBN);
            const encryptedBid = buffer.encrypt();

            logMessage("Submitting encrypted bid...");
            const tx = await contract.placeBid(encryptedBid.handles[0], encryptedBid.inputProof, {
                value: bidAmountWei.toString()
            });
            logMessage(`Tx sent: ${tx.hash}`, "pending");

            const receipt = await tx.wait();
            if (receipt.status === 1) {
                logMessage(`Bid confirmed. Block ${receipt.blockNumber}`, "confirmed");
                showNotification("Bid placed successfully!", "success");
            } else {
                logMessage("Tx failed.", "failed");
                showNotification("Bid failed.", "error");
            }
        } catch (err) {
            console.error("placeBid failed:", err);
            logMessage(`[ERROR] ${err.message}`, "failed");
            showNotification(`Error: ${err.message}`, "error");
        }
    }

    // === Event listeners ===
    document.getElementById('connectWallet').addEventListener('click', connectWallet);
    document.getElementById('placeBid').addEventListener('click', placeBid);
    </script>
</body>
</html>
