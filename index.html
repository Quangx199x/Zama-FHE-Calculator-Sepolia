<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zama FHE Terminal - ƒê·∫•u Gi√° B·∫£o M·∫≠t</title>
    <!-- Th∆∞ vi·ªán Ethers.js -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
    <!-- ‚ö°Ô∏è ZAMA FHE RELAYER SDK (B·∫£n th·∫≠t) ‚ö°Ô∏è -->
    <script src="https://cdn.jsdelivr.net/npm/@zama-fhe/relayer-sdk@latest/dist/relayer-sdk.min.js"></script>
    
    <!-- Font Style -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* CSS Styles (Simplified for brevity, same as previous version) */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'VT323', monospace; background-color: #000000; color: #00ff00; min-height: 100vh; padding: 20px; font-size: 18px; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 40px; animation: fadeIn 1s ease-out; }
        h1 { font-size: 3em; margin-bottom: 5px; text-shadow: 0 0 5px #00ff00, 0 0 15px rgba(0, 255, 0, 0.8); }
        .subtitle { font-size: 1.2em; opacity: 0.9; }
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 30px; margin-bottom: 30px; }
        .card { background-color: #000000; border: 2px solid #00ff00; padding: 25px; box-shadow: 0 0 10px rgba(0, 255, 0, 0.5); animation: fadeInUp 1s ease-out; }
        .card h2 { margin-bottom: 20px; font-size: 1.8em; color: #ffff00; border-bottom: 1px dashed #00ff00; padding-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        input { width: 100%; padding: 12px; border: 1px solid #00ff00; background: #000; color: #00ff00; font-size: 1em; font-family: 'VT323', monospace; margin-bottom: 15px; caret-color: #ffff00; box-shadow: 0 0 5px rgba(0, 255, 0, 0.2); transition: border-color 0.2s; }
        input:focus { outline: none; border-color: #ffff00; box-shadow: 0 0 8px #ffff00; }
        button { background: #000; border: 2px solid #00ff00; padding: 12px 20px; color: #00ff00; font-size: 1.1em; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; transition: all 0.2s ease; font-family: 'VT323', monospace; letter-spacing: 1px; text-transform: uppercase; }
        button:hover { background: #00ff00; color: #000000; box-shadow: 0 0 15px #00ff00; }
        button:disabled { opacity: 0.4; cursor: not-allowed; background: #000; color: #00ff00; box-shadow: none; }
        .auction-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .info-item { background: #0a0a0a; padding: 15px; border: 1px solid #00ff00; text-align: center; }
        .info-label { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
        .info-value { font-size: 1.5em; font-weight: bold; color: #ffff00; }
        .wallet-status { padding: 15px; background: #0a0a0a; border: 1px dashed #00ff00; margin-bottom: 20px; text-align: left; }
        .fhe-badge { display: inline-block; background: #00ff00; color: #000; padding: 3px 8px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; margin-left: 10px; border: 1px solid #00ff00; box-shadow: 0 0 5px #00ff00; }
        .encrypted-badge { display: flex; align-items: center; gap: 10px; background: #111; padding: 10px; border: 1px solid #00ff00; margin-top: 10px; }
        .encrypted-badge::before { content: "üîí"; font-size: 1.2em; filter: drop-shadow(0 0 3px #00ff00); }
        .tx-monitor { grid-column: 1 / -1; }
        .tx-container { height: 300px; background: #0a0a0a; border: 1px solid #00ff00; overflow-y: auto; padding: 10px; line-height: 1.4; white-space: pre-wrap; position: relative; }
        .tx-container::-webkit-scrollbar { width: 8px; }
        .tx-container::-webkit-scrollbar-thumb { background: #00ff00; }
        .tx-container::-webkit-scrollbar-track { background: #0a0a0a; }
        .log-line { opacity: 0; animation: fadeIn 0.5s ease-out forwards; padding: 2px 0; }
        .log-time { color: #ffff00; margin-right: 10px; }
        .log-pending { color: orange; }
        .log-confirmed { color: #00ff00; }
        .log-failed { color: #ff0000; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { transform: translateY(0); } }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; background: #000; border: 2px solid; box-shadow: 0 0 10px; animation: slideInRight 0.4s ease; z-index: 1000; font-family: 'VT323', monospace; }
        .notification.success { border-color: #00ff00; box-shadow-color: rgba(0, 255, 0, 0.7); color: #00ff00; }
        .notification.error { border-color: #ff0000; box-shadow-color: rgba(255, 0, 0, 0.7); color: #ff0000; }
        .notification.info { border-color: #ffff00; box-shadow-color: rgba(255, 255, 0, 0.7); color: #ffff00; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .loading { display: inline-block; width: 1em; height: 1em; border: 0.15em solid rgba(0, 255, 0, 0.3); border-radius: 50%; border-top-color: #00ff00; animation: spin 1s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .reveal-btn { background: #ff0000; color: #fff; border-color: #ff0000; }
        .reveal-btn:hover { background: #ff5555; box-shadow: 0 0 15px #ff0000; }
        @media (min-width: 768px) { .main-grid { grid-template-columns: 2fr 3fr; } .tx-monitor { grid-column: 1 / 3; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>[SYSTEM ONLINE] ZAMA FHE AUCTION $</h1>
            <p class="subtitle">ƒê·∫•u gi√° b·∫£o m·∫≠t ho√†n to√†n ƒë·ªìng h√¨nh (FHE) - Sepolia Testnet Ready.</p>
        </header>

        <div class="main-grid">
            <!-- Terminal 1: Wallet Connection -->
            <div class="card wallet-section">
                <h2>> INIT WALLET SERVICE & FHE SDK</h2>
                <div class="wallet-status" id="walletStatus">
                    <p class="log-line log-info">[STATUS] Wallet: DISCONNECTED</p>
                    <p class="log-line log-info">[INFO] Target Network: **Sepolia (11155111)**</p>
                    <p class="log-line log-pending" id="fheStatus">[FHE SDK] Initializing Relayer Public Key...</p>
                </div>
                <button id="connectBtn" onclick="connectWallet()">
                    &gt; CONNECT & CHECK NETWORK
                </button>
            </div>

            <!-- Terminal 2: Auction State -->
            <div class="card">
                <h2>> AUCTION DATA FEED (FHE PROTECTED)</h2>
                <div class="auction-info">
                    <div class="info-item">
                        <div class="info-label">Current Bid (Encrypted)</div>
                        <div class="info-value" id="currentBid">CIPHERTEXT</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Lead Bidder</div>
                        <div class="info-value" id="leadBidder">0x0000...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Min Bid Deposit</div>
                        <div class="info-value" id="minDepositValue">-- ETH</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Time Remaining</div>
                        <div class="info-value" id="timeLeft">--:--:--</div>
                    </div>
                </div>
                <!-- N√∫t Request Decrypt ch·ªâ hi·ªÉn th·ªã khi ƒë·∫•u gi√° k·∫øt th√∫c -->
                <button id="revealBtn" class="reveal-btn" onclick="requestDecryptResults()" disabled style="display: none;">
                    &gt; REQUEST DECRYPT AUCTION WINNER & REFUND $
                </button>
            </div>

            <!-- Terminal 3: Place Bid -->
            <div class="card" style="grid-column: 1 / -1;">
                <h2>> FHE BID SUBMISSION</h2>
                <label for="bidAmount" class="log-line">[INPUT] Enter Amount (ETH):</label>
                <input 
                    type="number" 
                    id="bidAmount" 
                    placeholder="ETH value (must meet min deposit)" 
                    step="0.001"
                    min="0"
                >
                <div class="encrypted-badge">
                    <span>S·ª≠ d·ª•ng **@zama-fhe/relayer-sdk** ƒë·ªÉ m√£ h√≥a **euint64** v√† t·∫°o proof client-side.</span>
                </div>
                <button id="bidBtn" onclick="placeBid()" disabled>
                    &gt; SUBMIT ENCRYPTED BID $ (Sepolia)
                </button>
            </div>

            <!-- Terminal 4: Live Transaction Monitor (Log) -->
            <div class="card tx-monitor">
                <h2>> LIVE TRANSACTION LOG <span class="fhe-badge">FHEVM</span></h2>
                <div class="tx-container" id="txContainer">
                    <p class="log-line" style="animation-delay: 0.1s;"><span class="log-time">[00:00:00]</span> [CORE] System initialization complete. Awaiting wallet connection on Sepolia...</p>
                    <p class="log-line" style="animation-delay: 0.2s;"><span class="log-time">[00:00:01]</span> [FHE] Loading Zama SDK and Sepolia configuration...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ZAMA FHE SDK & CONFIGURATION ---
        
        // C·∫ßn thay th·∫ø ƒë·ªãa ch·ªâ n√†y b·∫±ng ƒë·ªãa ch·ªâ contract FHEAuction ƒë√£ tri·ªÉn khai tr√™n Sepolia FHEVM
        const CONTRACT_ADDRESS = '0x4140e9d65f5161c15843bd69413b691388230341'; 
        
        // C·∫¨P NH·∫¨T ABI: Bao g·ªìm c√°c h√†m public state, h√†m requestDecryptMaxBid v√† events
        const FHE_AUCTION_ABI = [{"inputs":[{"internalType":"uint256","name":"_durationInSeconds","type":"uint256"},{"internalType":"uint256","name":"_minDeposit","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"HandlesAlreadySavedForRequestID","type":"error"},{"inputs":[],"name":"InvalidKMSSignatures","type":"error"},{"inputs":[],"name":"InvalidShortString","type":"error"},{"inputs":[],"name":"NoHandleFoundForRequestID","type":"error"},{"inputs":[],"name":"ReentrancyGuardReentrantCall","type":"error"},{"inputs":[{"internalType":"string","name":"str","type":"string"}],"name":"StringTooLong","type":"error"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"finalDeposit","type":"uint256"}],"name":"AuctionFinished","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":false,"internalType":"uint256","name":"depositAmount","type":"uint256"},{"indexed":false,"internalType":"bool","name":"isNewLeader","type":"bool"}],"name":"BidReceived","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BidderWithdrew","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"requestID","type":"uint256"}],"name":"DecryptionFulfilled","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"requestId","type":"uint256"}],"name":"DecryptionRequested","type":"event"},{"anonymous":false,"inputs":[],"name":"EIP712DomainChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RefundIssued","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[],"name":"auctionEndTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auctionFinalized","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"externalEuint64","name":"encryptedBid","type":"bytes32"},{"internalType":"bytes","name":"proof","type":"bytes"}],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"currentLeadBidder","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentLeadDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"eip712Domain","outputs":[{"internalType":"bytes1","name":"fields","type":"bytes1"},{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"version","type":"string"},{"internalType":"uint256","name":"chainId","type":"uint256"},{"internalType":"address","name":"verifyingContract","type":"address"},{"internalType":"bytes32","name":"salt","type":"bytes32"},{"internalType":"uint256[]","name":"extensions","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"emergencyCancel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"finalizeAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAuctionEndTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCurrentLeadBidder","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCurrentLeadDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMinBidDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isAuctionFinalized","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"bidder","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"manualRefund","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"minBidDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"requestId","type":"uint256"},{"internalType":"bytes","name":"cleartexts","type":"bytes"},{"internalType":"bytes","name":"decryptionProof","type":"bytes"}],"name":"onDecryptionCallback","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"protocolId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"address","name":"bidder","type":"address"}],"name":"requestDecryptBidderBid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"requestDecryptMaxBid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newLeader","type":"address"},{"internalType":"uint256","name":"newDeposit","type":"uint256"}],"name":"updateLeaderAfterReveal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"winningBid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawWinnings","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}]

        // C·∫•u h√¨nh FHEVM Sepolia
        const SEPOLIA_CHAIN_ID = 11155111; 
        
        // Tr·∫°ng th√°i chung
        let provider;
        let signer;
        let account;
        let fheAuctionContract;
        let fhevmInstance = null; 
        let timerInterval; // Bi·∫øn l∆∞u tr·ªØ interval c·ªßa ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c
        
        // Tr·∫°ng th√°i ƒë·∫•u gi√° 
        let minDepositWei = ethers.BigNumber.from(0); 
        let auctionEndTime = 0; 
        let auctionFinalized = false;
        
        // --- UTILITY FUNCTIONS ---

        function formatLogTime() {
            const date = new Date();
            return `[${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}]`;
        }
        
        function logMessage(message, type = 'info') {
            const container = document.getElementById('txContainer');
            const logElement = document.createElement('p');
            logElement.className = `log-line log-${type}`;
            logElement.style.animationDelay = '0s';
            logElement.innerHTML = `<span class="log-time">${formatLogTime()}</span> ${message}`;
            container.prepend(logElement);
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = `[${type.toUpperCase()}] ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => { notification.remove(); }, 4000);
        }

        // --- FHE SDK INITIALIZATION ---

        async function initFhevmSdk(currentProvider) {
            // C·ªë g·∫Øng s·ª≠ d·ª•ng t√™n global m·ªõi (ZamaFheRelayerSdk)
            const ZamaFhe = window.ZamaFheRelayerSdk || window.ZamaFhe;

            if (typeof ZamaFhe === 'undefined') {
                logMessage('[ERROR] Zama SDK is not loaded. Check CDN link.', 'failed');
                return null;
            }

            const fheStatus = document.getElementById('fheStatus');
            try {
                fheStatus.textContent = '[FHE SDK] Fetching public key from FHE Relayer...';
                
                // S·ª¨A L·ªñI C√ö PH√ÅP INIT: S·ª≠ d·ª•ng createInstance (chu·∫©n v0.9+)
                const { createInstance, SepoliaConfig } = ZamaFhe;
                const sdk = await createInstance(SepoliaConfig);

                fheStatus.textContent = '[FHE SDK] Public Key loaded. Ready for encryption.';
                fheStatus.className = 'log-line log-confirmed';
                logMessage('[FHE] SDK initialized successfully. Client-side encryption enabled.', 'confirmed');
                return sdk;

            } catch (error) {
                console.error("FHE SDK Initialization failed:", error);
                fheStatus.textContent = '[FHE SDK] FAILED to load public key. Check FHEVM RPC/Relayer.';
                fheStatus.className = 'log-line log-failed';
                return null;
            }
        }

        // --- CONTRACT STATE & EVENTS ---

        async function getAuctionState() {
            try {
                // L·∫•y th√¥ng tin tr·∫°ng th√°i
                const [minDeposit, endTime, leadBidder, leadDeposit, finalized, winningBidValue] = await Promise.all([
                    fheAuctionContract.getMinBidDeposit(),
                    fheAuctionContract.getAuctionEndTime(),
                    fheAuctionContract.getCurrentLeadBidder(),
                    fheAuctionContract.getCurrentLeadDeposit(),
                    fheAuctionContract.isAuctionFinalized(),
                    fheAuctionContract.winningBid()
                ]);

                // 1. C·∫≠p nh·∫≠t Min Deposit
                minDepositWei = minDeposit;
                const minDepositEth = ethers.utils.formatEther(minDeposit);
                document.getElementById('minDepositValue').textContent = `${minDepositEth} ETH`;

                // 2. C·∫≠p nh·∫≠t Auction End Time
                auctionEndTime = endTime.toNumber() * 1000; // Chuy·ªÉn t·ª´ gi√¢y Unix sang mili gi√¢y JS
                
                // 3. C·∫≠p nh·∫≠t Lead Bidder
                const bidderDisplay = leadBidder === ethers.constants.AddressZero 
                    ? '0x0000...' 
                    : `${leadBidder.substring(0, 6)}...`;
                document.getElementById('leadBidder').textContent = bidderDisplay;
                
                // 4. C·∫≠p nh·∫≠t Current Bid (Encrypted or Winning Bid if finalized)
                if (finalized) {
                    const winningBidEth = ethers.utils.formatEther(winningBidValue);
                    document.getElementById('currentBid').textContent = `${winningBidEth} ETH (WINNER)`;
                } else {
                    document.getElementById('currentBid').textContent = 'ENCRYPTED';
                }

                auctionFinalized = finalized;

                logMessage('[CONTRACT] Initial state loaded: Deposit, End Time, Lead Bidder, and Status.', 'info');
                return true;
            } catch (error) {
                console.error("Failed to fetch auction state:", error);
                logMessage(`[ERROR] Failed to fetch auction state. Contract address wrong? ${error.message}`, 'failed');
                return false;
            }
        }

        function listenToEvents() {
            if (!fheAuctionContract) return;

            // 1. L·∫Øng nghe BidReceived
            fheAuctionContract.on("BidReceived", (bidder, depositAmount, isNewLeader, event) => {
                const bidderShort = bidder.substring(0, 6);
                const depositEth = ethers.utils.formatEther(depositAmount);
                
                let message;
                let type = 'info';

                if (isNewLeader) {
                    message = `[BID:NEW] New leader bid by ${bidderShort}... Amount: ${depositEth} ETH`;
                    type = 'confirmed';
                } else {
                    message = `[BID:RECEIVED] Bid by ${bidderShort}... Amount: ${depositEth} ETH (not leader)`;
                    type = 'pending';
                }
                logMessage(message, type);

                // C·∫≠p nh·∫≠t th√¥ng tin d·∫´n ƒë·∫ßu
                document.getElementById('leadBidder').textContent = `${bidderShort}...`;
            });

            // 2. L·∫Øng nghe AuctionFinished
            fheAuctionContract.on("AuctionFinished", async (winner, finalDeposit, event) => {
                logMessage('[FINISH] AuctionFinished Event received from contract!', 'confirmed');
                
                // Final Deposit ·ªü ƒë√¢y l√† gi√° tr·ªã plaintext ƒë√£ ƒë∆∞·ª£c c√¥ng b·ªë tr√™n chain
                const finalDepositETH = ethers.utils.formatEther(finalDeposit);
                const winnerAddress = winner;
                
                // 3. Update Public Display
                document.getElementById('currentBid').textContent = `${finalDepositETH} ETH (WINNER)`;
                document.getElementById('leadBidder').textContent = winnerAddress.substring(0, 10) + '...';
                
                logMessage(`[SUCCESS] AUCTION FINALIZED! Winning deposit: ${finalDepositETH} ETH. Winner: ${winnerAddress}.`, 'confirmed');
                showNotification(`AUCTION ENDED. Winner: ${winnerAddress.substring(0, 6)}... with ${finalDepositETH} ETH.`, 'success');

                // Ng·ª´ng l·∫Øng nghe ƒë·ªÉ tr√°nh c·∫≠p nh·∫≠t th√™m
                fheAuctionContract.removeAllListeners("BidReceived");
                fheAuctionContract.removeAllListeners("AuctionFinished");
            });

            // 3. L·∫Øng nghe DecryptionRequested
            fheAuctionContract.on("DecryptionRequested", (requestId, event) => {
                logMessage(`[DECRYPT] Decryption requested. Request ID: ${requestId}. Awaiting callback...`, 'pending');
            });

            logMessage('[EVENT] Event listeners registered for BidReceived, AuctionFinished, and DecryptionRequested.', 'info');
        }

        // --- WALLET & CONNECTION ---

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showNotification('ERROR: MetaMask not detected.', 'error');
                return;
            }

            try {
                logMessage('[PROMPT] Requesting connection and network switch to Sepolia...', 'info');
                
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: `0x${SEPOLIA_CHAIN_ID.toString(16)}` }],
                });

                provider = new ethers.providers.Web3Provider(window.ethereum);
                const network = await provider.getNetwork();

                if (network.chainId !== SEPOLIA_CHAIN_ID) {
                    throw new Error("Wrong network. Please switch to Sepolia (11155111).");
                }

                signer = provider.getSigner();
                account = await signer.getAddress();
                
                fhevmInstance = await initFhevmSdk(provider);
                if (!fhevmInstance) {
                    throw new Error("FHE SDK failed to initialize. Cannot proceed.");
                }

                fheAuctionContract = new ethers.Contract(
                    CONTRACT_ADDRESS, 
                    FHE_AUCTION_ABI, 
                    signer
                );
                
                // ‚ö°Ô∏è L·∫§Y TR·∫†NG TH√ÅI BAN ƒê·∫¶U V√Ä L·∫ÆNG NGHE ‚ö°Ô∏è
                await getAuctionState();
                listenToEvents();

                document.getElementById('walletStatus').innerHTML = `
                    <p class="log-line log-confirmed">[STATUS] Wallet: CONNECTED & READY</p>
                    <p class="log-line">[ADDRESS] ${account.substring(0, 10)}...</p>
                    <p class="log-line">[NETWORK] **Sepolia FHEVM**</p>
                `;

                document.getElementById('connectBtn').textContent = '> CONNECTION ESTABLISHED (Sepolia)';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('bidBtn').disabled = false;

                showNotification('Connected to Sepolia. FHE interface ready.', 'success');
                logMessage('[SUCCESS] Wallet, Network, and Contract OK. Ready to bid.', 'confirmed');
                startAuctionTimer();
            } catch (error) {
                console.error(error);
                const msg = error.message.includes('User rejected') ? 'User rejected connection/switch.' : error.message;
                showNotification('Connection Failed: ' + msg, 'error');
                logMessage(`[ERROR] Connection failed: ${msg}`, 'failed');
                document.getElementById('bidBtn').disabled = true;
            }
        }

        // --- BIDDING LOGIC ---

        async function placeBid() {
            const bidInput = document.getElementById('bidAmount');
            let bidAmountETH = parseFloat(bidInput.value);
            
            if (!fheAuctionContract || !account || !fhevmInstance) {
                showNotification('Wallet/SDK not initialized. Connect wallet first.', 'error');
                return;
            }
            if (Date.now() > auctionEndTime) {
                showNotification('Auction has ended. Cannot place bid.', 'error');
                return;
            }
            if (isNaN(bidAmountETH) || bidAmountETH <= 0) {
                showNotification('Invalid bid amount entered.', 'error');
                return;
            }
            
            const bidAmountWei = ethers.utils.parseEther(bidAmountETH.toString());
            
            // 1. Ki·ªÉm tra Min Deposit
            if (bidAmountWei.lt(minDepositWei)) {
                showNotification(`Deposit must be at least ${ethers.utils.formatEther(minDepositWei)} ETH.`, 'error');
                return;
            }

            // Chuy·ªÉn sang Gwei cho euint64 (ch√≠nh x√°c h∆°n)
            const bidAmountGwei = bidAmountWei.div(ethers.BigNumber.from(1e9)).toNumber();
            
            const MAX_EUINT64_GWEI = ethers.BigNumber.from("18446744073709551615");
            if (ethers.BigNumber.from(bidAmountGwei).gt(MAX_EUINT64_GWEI)) {
                   showNotification('Bid amount too high for euint64 Gwei representation.', 'error');
                   return;
            }

            const btn = document.getElementById('bidBtn');
            try {
                
                btn.innerHTML = '<span class="loading"></span> ENCRYPTING (SDK)...';
                btn.disabled = true;
                
                logMessage(`[PROCESS] Initiating Zama SDK encryption for bid: ${bidAmountGwei} Gwei (**euint64**).`, 'info');

                // 2. ZAMA SDK: S·ª≠ d·ª•ng Encrypted Input Buffer ƒë·ªÉ m√£ h√≥a euint64
                
                // Kh·ªüi t·∫°o Buffer ƒë·ªÉ ch·ª©a c√°c tham s·ªë m√£ h√≥a cho contract
                // C·∫ßn CONTRACT_ADDRESS v√† ƒë·ªãa ch·ªâ account ƒë·ªÉ l·∫•y Public Key c·ªßa ng∆∞·ªùi d√πng
                const buffer = fhevmInstance.createEncryptedInput(CONTRACT_ADDRESS, account);

                // Th√™m gi√° tr·ªã bid (euint64) v√†o buffer. Ph·∫£i d√πng BigInt cho add64.
                buffer.add64(BigInt(bidAmountGwei));

                // Th·ª±c hi·ªán m√£ h√≥a v√† t·∫°o Proof
                const { encryptedValue: encryptedHandle, proof: proofBytes } = await buffer.encrypt();

                logMessage(`[FHE] Encryption complete. Handle: ${encryptedHandle.substring(0, 10)}... Proof generated.`, 'info');

                // 3. Ethers: Submit Transaction
                btn.innerHTML = '<span class="loading"></span> SUBMITTING TX...';
                
                // Giao d·ªãch g·ªçi contract.bid(externalEuint64 encryptedHandle, bytes proof) v√† g·ª≠i k√®m ETH (msg.value)
                const tx = await fheAuctionContract.bid(encryptedHandle, proofBytes, {
                    value: bidAmountWei // G·ª≠i s·ªë ETH ng∆∞·ªùi d√πng nh·∫≠p l√†m k√Ω qu·ªπ (Wei)
                }); 
                
                logMessage(`[TX] Sending encrypted bid transaction. Hash: ${tx.hash.substring(0, 10)}...`, 'pending');

                // Ch·ªù x√°c nh·∫≠n giao d·ªãch
                const receipt = await tx.wait(); 
                
                logMessage(`[SUCCESS] TX ${receipt.transactionHash.substring(0, 10)}... confirmed. FHE computation passed on-chain.`, 'confirmed');
                showNotification('Encrypted Bid Confirmed! (FHE Contract Logic Executed)', 'success');
                bidInput.value = '';

            } catch (error) {
                console.error("Bid Failed:", error);
                const msg = error.reason || error.message || 'Transaction Failed';
                showNotification(`TX FAILED: ${msg}`, 'error');
                logMessage(`[FATAL] Transaction failed: ${msg}`, 'failed');
            } finally {
                btn.innerHTML = '> SUBMIT ENCRYPTED BID $ (Sepolia)';
                if (document.getElementById('connectBtn').disabled && Date.now() < auctionEndTime) {
                    btn.disabled = false; 
                }
            }
        }
        
        // --- DECRYPT LOGIC (Contract Call) ---

        async function requestDecryptResults() {
            if (!account || !fheAuctionContract) {
                showNotification('Wallet or contract not initialized.', 'error');
                return;
            }
            logMessage('[DECRYPT] Auction ended. Initiating contract DECRYPT REQUEST...', 'info');
            
            const btn = document.getElementById('revealBtn');
            btn.innerHTML = '<span class="loading"></span> REQUESTING DECRYPT...';
            btn.disabled = true;

            try {
                // 1. G·ªçi h√†m requestDecryptMaxBid() tr√™n contract (ch·ªâ owner)
                const tx = await fheAuctionContract.requestDecryptMaxBid();
                logMessage(`[TX] Sending DECRYPT REQUEST transaction. Hash: ${tx.hash.substring(0, 10)}...`, 'pending');

                await tx.wait(); 
                
                logMessage(`[SUCCESS] DECRYPT REQUEST TX confirmed. Waiting for DecryptionRequested event and callback...`, 'confirmed');
                showNotification('Decrypt request confirmed. Waiting for relayer callback and AuctionFinished event.', 'info');

                // Logic l·∫Øng nghe s·ª± ki·ªán AuctionFinished s·∫Ω x·ª≠ l√Ω ph·∫ßn c√≤n l·∫°i.

            } catch (error) {
                console.error("Decrypt Request Failed:", error);
                const msg = error.reason || error.message || 'Decrypt Request Failed';
                logMessage(`[FATAL] Decrypt request failed: ${msg}`, 'failed');
                showNotification(`DECRYPT REQUEST FAILED: ${msg}`, 'error');
            } finally {
                btn.innerHTML = '> REQUEST DECRYPT AUCTION WINNER & REFUND $';
                btn.disabled = false;
            }
        }

        // --- TIMER & LIVE FEED ---

        function startAuctionTimer() {
            const timerElement = document.getElementById('timeLeft');
            
            if (timerInterval) { clearInterval(timerInterval); } // X√≥a interval c≈©

            timerInterval = setInterval(() => {
                const remaining = auctionEndTime - Date.now();
                
                if (remaining <= 0) {
                    timerElement.textContent = 'AUCTION CLOSED!';
                    clearInterval(timerInterval);
                    document.getElementById('bidBtn').style.display = 'none';
                    document.getElementById('revealBtn').style.display = 'block';
                    document.getElementById('revealBtn').disabled = false;

                    // N·∫øu ƒë·∫•u gi√° k·∫øt th√∫c, khuy·∫øn kh√≠ch ng∆∞·ªùi d√πng g·ªçi decrypt request (n·∫øu owner)
                    logMessage('[ALERT] Auction has ended. Owner: Call REQUEST DECRYPT to finalize results and initiate refunds.', 'info');
                    return;
                }
                
                const hours = Math.floor(remaining / 3600000);
                const minutes = Math.floor((remaining % 3600000) / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                
                timerElement.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            logMessage('[INFO] Zama SDK CDN loaded. Awaiting MetaMask connection.', 'info');
            // B·∫Øt ƒë·∫ßu timer t·∫°m th·ªùi cho ƒë·∫øn khi k·∫øt n·ªëi v√† l·∫•y th·ªùi gian th·ª±c t·ª´ contract
            auctionEndTime = Date.now() + 30000; // 30 gi√¢y t·∫°m th·ªùi
            startAuctionTimer();
        });
    </script>
</body>
</html>
