<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHE Calculator - Zama</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/@zama-fhe/relayer-sdk@latest/dist/index.umd.js"></script>
    <style>
        /* Giữ nguyên các style như trong code gốc */
    </style>
</head>
<body>
    <!-- Giữ nguyên phần HTML như trong code gốc -->

    <script>
        const CONTRACT_ADDRESS = '0xE822E0Cba6205b85CFAa48b0DD028Fc74F17975F';
        const SEPOLIA_CHAIN_ID = 11155111n;
        const SEPOLIA_CONFIG = {
            chainId: '0xaa36a7',
            name: 'Sepolia',
            nativeCurrency: { name: 'Sepolia Ether', symbol: 'SEP', decimals: 18 },
            rpcUrls: ['https://rpc.sepolia.org'],
            blockExplorerUrls: ['https://sepolia.etherscan.io']
        };
        const CONTRACT_ABI = [
            {"inputs":[{"internalType":"externalEuint32","name":"inputEuint32","type":"bytes32"},{"internalType":"bytes","name":"inputProof","type":"bytes"}],"name":"add","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"getResult","outputs":[{"internalType":"euint32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"externalEuint32","name":"inputEuint32","type":"bytes32"},{"internalType":"bytes","name":"inputProof","type":"bytes"}],"name":"subtract","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        let provider;
        let signer;
        let userAddress;
        let contract;
        let fhevmInstance;

        // Kiểm tra SDK đã load xong chưa
        window.addEventListener('load', async () => {
            if (typeof window.relayerSdk === 'undefined') {
                showNotification('Zama SDK chưa tải xong!', 'error');
                return;
            }
            
            // Tự động kiểm tra SDK mỗi 500ms cho đến khi sẵn sàng
            const checkSDK = setInterval(() => {
                if (window.relayerSdk && window.relayerSdk.createInstance) {
                    clearInterval(checkSDK);
                    showNotification('Zama SDK đã sẵn sàng!', 'success');
                }
            }, 500);
        });

        function createCoin() {
            // Giữ nguyên như code gốc
        }

        function showNotification(message, type = 'info') {
            // Giữ nguyên như code gốc
        }

        async function encryptWithSDK(value, contractAddress, userAddress) {
            if (!fhevmInstance) throw new Error('FHEVM SDK not initialized');
            const buffer = fhevmInstance.createEncryptedInput(contractAddress, userAddress);
            buffer.add32(BigInt(value));
            const ciphertexts = await buffer.encrypt();
            return {
                encrypted: ciphertexts.handles[0],
                proof: ciphertexts.inputProof
            };
        }

        async function decryptWithSDK(encryptedHandle, contractAddress) {
            if (!fhevmInstance || !signer) throw new Error('FHEVM SDK or signer not ready');
            const keypair = fhevmInstance.generateKeypair();
            const handleContractPairs = [{ handle: encryptedHandle, contractAddress }];
            const startTimeStamp = Math.floor(Date.now() / 1000).toString();
            const durationDays = '10';
            const contractAddresses = [contractAddress];

            const eip712 = fhevmInstance.createEIP712(
                keypair.publicKey,
                contractAddresses,
                startTimeStamp,
                durationDays
            );

            const signature = await signer.signTypedData(
                eip712.domain,
                { UserDecryptRequestVerification: eip712.types.UserDecryptRequestVerification },
                eip712.message
            );

            const result = await fhevmInstance.userDecrypt(
                handleContractPairs,
                keypair.privateKey,
                keypair.publicKey,
                signature.replace('0x', ''),
                contractAddresses,
                await signer.getAddress(),
                startTimeStamp,
                durationDays
            );

            return result[encryptedHandle];
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showNotification('MetaMask chưa được cài đặt!', 'error');
                    return;
                }

                // Kiểm tra SDK tồn tại
                if (typeof window.relayerSdk === 'undefined' || !window.relayerSdk.createInstance) {
                    showNotification('Zama SDK chưa sẵn sàng. Vui lòng tải lại trang!', 'error');
                    return;
                }

                showNotification('Đang kết nối MetaMask...', 'info');
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                let network = await provider.getNetwork();

                if (network.chainId !== SEPOLIA_CHAIN_ID) {
                    showNotification('Đang chuyển sang Sepolia...', 'info');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [SEPOLIA_CONFIG],
                                });
                            } catch (addError) {
                                showNotification('Không thể thêm Sepolia. Vui lòng thêm thủ công!', 'error');
                                return;
                            }
                        } else {
                            showNotification('Chuyển network thất bại!', 'error');
                            return;
                        }
                    }
                    network = await provider.getNetwork();
                    if (network.chainId !== SEPOLIA_CHAIN_ID) {
                        showNotification('Network không đúng!', 'error');
                        return;
                    }
                }

                // Khởi tạo SDK
                const { createInstance, SepoliaConfig } = window.relayerSdk;
                fhevmInstance = await createInstance(SepoliaConfig);

                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                document.getElementById('networkBadge').textContent = 'SEPOLIA';
                document.getElementById('walletAddress').textContent = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                document.getElementById('walletAddress').style.display = 'block';
                const connectBtn = document.getElementById('connectBtn');
                connectBtn.textContent = 'CONNECTED';
                connectBtn.classList.add('connected');
                connectBtn.disabled = true;
                document.getElementById('addBtn').disabled = false;
                document.getElementById('subBtn').disabled = false;
                document.getElementById('refreshBtn').disabled = false;
                await refreshResult();
                showNotification(`Kết nối thành công: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`, 'success');
            } catch (error) {
                console.error('Lỗi kết nối:', error);
                showNotification('Kết nối ví thất bại: ' + error.message, 'error');
            }
        }

        // Các hàm performAdd, performSubtract, refreshResult giữ nguyên như code gốc

        // Kiểm tra MetaMask
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    connectWallet();
                }
            });
            window.ethereum.on('chainChanged', () => {
                location.reload();
            });
        }
    </script>
</body>
</html>
