<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHE Auction Bidder</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.0.0/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fhevmjs@latest/umd/fhevm.min.js"></script>
</head>
<body>
    <h1>FHE Auction Bidder</h1>
    <button id="connectWallet">Connect Wallet</button>
    <p id="walletAddress"></p>
    <input type="number" id="bidValue" placeholder="Enter Bid Value (uint64)" min="0" max="18446744073709551615">
    <input type="number" id="depositValue" placeholder="Enter Deposit ETH (in wei)" min="100000000000000000"> <!-- Ví dụ min 0.1 ETH -->
    <button id="placeBid" disabled>Place Bid</button>
    <p id="status"></p>

    <script>
        const CONTRACT_ADDRESS = '0xYourDeployedContractAddressHere'; // Thay bằng address contract
        const CONTRACT_ABI = [ // ABI của hàm bid
            'function bid(externalEuint64 encryptedBid, bytes calldata inputProof, bytes32 publicKey, bytes calldata signature) external payable'
        ];
        const CHAIN_ID = 11155111; // Sepolia
        const GATEWAY_URL = 'https://gateway.testnet.zama.ai'; // Gateway cho fhevmjs

        let provider, signer, contract, instance;

        // Khởi tạo fhevmjs
        async function initFhevm() {
            instance = await createFhevmInstance({ chainId: CHAIN_ID, publicKey: await fetchPublicKey() });
        }

        async function fetchPublicKey() {
            const response = await fetch(`${GATEWAY_URL}/get_public_key`);
            const { publicKey } = await response.json();
            return publicKey;
        }

        // Kết nối ví
        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                signer = await provider.getSigner();
                const address = await signer.getAddress();
                document.getElementById('walletAddress').textContent = `Connected: ${address}`;
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                await initFhevm();
                document.getElementById('placeBid').disabled = false;
                document.getElementById('status').textContent = 'Ready to bid.';
            } else {
                alert('Install MetaMask!');
            }
        });

        // Đặt bid
        document.getElementById('placeBid').addEventListener('click', async () => {
            const bidValue = BigInt(document.getElementById('bidValue').value);
            const depositValue = BigInt(document.getElementById('depositValue').value);

            if (!instance) return alert('Init fhevm first!');

            // Encrypt bid (euint64)
            const encryptedBid = instance.encrypt64(bidValue); // Trả về ciphertext (externalEuint64 format)
            const inputProof = instance.generateInputProof(encryptedBid); // Proof cho FHE.fromExternal

            // PublicKey: Sử dụng network public key (bytes32)
            const publicKey = instance.publicKey; // Từ instance

            // Ký publicKey (EIP712)
            const domain = {
                name: 'FHEAuction',
                version: '1',
                chainId: CHAIN_ID,
                verifyingContract: CONTRACT_ADDRESS
            };
            const types = {
                PublicKey: [{ name: 'key', type: 'bytes32' }]
            };
            const value = { key: publicKey };
            const signature = await signer.signTypedData(domain, types, value);

            // Gọi contract bid
            try {
                const tx = await contract.bid(encryptedBid, inputProof, publicKey, signature, { value: depositValue });
                document.getElementById('status').textContent = `Bid placed! Tx: ${tx.hash}`;
                await tx.wait();
                alert('Bid confirmed!');
            } catch (error) {
                console.error(error);
                document.getElementById('status').textContent = `Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>
