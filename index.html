<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHE Calculator - Zama</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <!-- Thêm CDN cho Zama Relayer SDK (kiểm tra version mới nhất trên unpkg.com) -->
    <script src="https://unpkg.com/@zama-fhe/relayer-sdk@0.1.0/dist/index.umd.js"></script> <!-- Thay version nếu cần -->
    <style>
        /* Giữ nguyên CSS từ code gốc */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        * {margin:0;padding:0;box-sizing:border-box;}
        body { font-family:'Press Start 2P',cursive; background:#1a1a2e; color:#ffd700; overflow-x:hidden; }
        /* ... (toàn bộ CSS gốc, không thay đổi) ... */
    </style>
</head>
<body>
    <!-- Giữ nguyên HTML body từ code gốc -->
    <header>
        <div class="social-icons">
            <a href="https://x.com/Quangx199x" target="_blank" rel="noopener noreferrer" title="X (Twitter)">
                <i class="fab fa-x-twitter"></i>
            </a>
            <a href="https://github.com/Quangx199x" target="_blank" rel="noopener noreferrer" title="GitHub">
                <i class="fab fa-github"></i>
            </a>
        </div>
        <div class="logo">FHE Calc</div>
        <nav>
            <a href="#calc">CALCULATOR</a>
            <a href="#about">ABOUT</a>
        </nav>
        <div class="wallet-info">
            <div id="walletAddress" class="wallet-address" style="display: none;"></div>
            <button class="connect-btn" id="connectBtn" onclick="connectWallet()">CONNECT WALLET</button>
        </div>
    </header>
    <section class="hero" id="calc">
        <h1>FHE CALCULATOR</h1>
        <p>Perform encrypted additions and subtractions with Zama FHE!</p>
        <div class="calc-container">
            <div class="calc-header">
                <h2>CALCULATOR</h2>
                <div class="network-badge" id="networkBadge">NOT CONNECTED</div>
            </div>
            <div class="result-display" id="resultDisplay">0x0000... (Encrypted)</div>
            <input type="number" class="value-input" id="valueInput" placeholder="Enter value" min="0">
            <div class="operation-buttons">
                <button class="op-btn" id="addBtn" onclick="performAdd()" disabled>+ ADD</button>
                <button class="op-btn" id="subBtn" onclick="performSubtract()" disabled>- SUB</button>
            </div>
            <button class="calc-btn" id="refreshBtn" onclick="refreshResult()" disabled>REFRESH RESULT</button>
            <div style="margin-top:20px;font-size:10px;color:#ffed4e;text-align:center;">
                <p>Contract: 0xE822...975F</p>
                <p>Network: Sepolia Testnet</p>
            </div>
        </div>
    </section>
    <section class="features" id="about">
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon"></div>
                <h3>ZAMA FHE</h3>
                <p>Powered by Zama's Fully Homomorphic Encryption for private computations on blockchain!</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon"></div>
                <h3>ENCRYPTED OPS</h3>
                <p>Perform additions and subtractions on encrypted data without revealing values!</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon"></div>
                <h3>SECURE</h3>
                <p>All operations are performed on encrypted data. Only you can decrypt the results!</p>
            </div>
        </div>
    </section>
    <footer>
        <p>ZAMA FHE CALCULATOR | DEMO ON SEPOLIA TESTNET ⛓️</p>
        <p style="margin-top:10px;">Built with Zama FHE & Ethers.js</p>
    </footer>

    <script>
        const CONTRACT_ADDRESS = '0xE822E0Cba6205b85CFAa48b0DD028Fc74F17975F';
        const SEPOLIA_CHAIN_ID = 11155111n;
        const CONTRACT_ABI = [
            {"inputs":[{"internalType":"externalEuint32","name":"inputEuint32","type":"bytes32"},{"internalType":"bytes","name":"inputProof","type":"bytes"}],"name":"add","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"getResult","outputs":[{"internalType":"euint32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"protocolId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"pure","type":"function"},
            {"inputs":[{"internalType":"externalEuint32","name":"inputEuint32","type":"bytes32"},{"internalType":"bytes","name":"inputProof","type":"bytes"}],"name":"subtract","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        let provider;
        let signer;
        let userAddress;
        let contract;
        let fhevmInstance; // Instance của Relayer SDK

        // Các hàm animation và notification giữ nguyên từ code gốc
        function createCoin() {
            const coin = document.createElement('div');
            coin.className = 'coin';
            coin.style.left = Math.random() * 100 + 'vw';
            coin.style.animationDuration = (Math.random() * 3 + 2) + 's';
            coin.style.opacity = Math.random() * 0.3 + 0.1;
            document.body.appendChild(coin);
            setTimeout(() => coin.remove(), 5000);
        }
        setInterval(createCoin, 500);

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<strong>${type.toUpperCase()}:</strong><br>${message}`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s reverse';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Thay mockEncrypt bằng encryptWithSDK (async)
        async function encryptWithSDK(value, contractAddress, userAddress) {
            if (!fhevmInstance) throw new Error('FHEVM SDK not initialized');
            const buffer = fhevmInstance.createEncryptedInput(contractAddress, userAddress);
            buffer.add32(BigInt(value)); // Mã hóa uint32
            const ciphertexts = await buffer.encrypt(); // Upload và generate proof
            return {
                encrypted: ciphertexts.handles[0], // bytes32 externalEuint32
                proof: ciphertexts.inputProof // bytes proof
            };
        }

        // Thêm hàm decryptWithSDK (async)
        async function decryptWithSDK(encryptedHandle, contractAddress) {
            if (!fhevmInstance || !signer) throw new Error('FHEVM SDK or signer not ready');
            const keypair = fhevmInstance.generateKeypair();
            const handleContractPairs = [{ handle: encryptedHandle, contractAddress }];
            const startTimeStamp = Math.floor(Date.now() / 1000).toString();
            const durationDays = '10'; // Thời hạn ACL (giây, nhưng dùng days cho demo)
            const contractAddresses = [contractAddress];

            const eip712 = fhevmInstance.createEIP712(
                keypair.publicKey,
                contractAddresses,
                startTimeStamp,
                durationDays
            );

            const signature = await signer.signTypedData(
                eip712.domain,
                { UserDecryptRequestVerification: eip712.types.UserDecryptRequestVerification },
                eip712.message
            );

            const result = await fhevmInstance.userDecrypt(
                handleContractPairs,
                keypair.privateKey,
                keypair.publicKey,
                signature.replace('0x', ''),
                contractAddresses,
                await signer.getAddress(),
                startTimeStamp,
                durationDays
            );

            return result[encryptedHandle]; // Giá trị plaintext (BigInt)
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showNotification('MetaMask not found! Please install MetaMask extension.', 'error');
                    return;
                }
                showNotification('Connecting to MetaMask...', 'info');
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner
