<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FHE Calculator - Sepolia</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f9; }
    h1 { color: #333; }
    .container { max-width: 500px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    input, button { margin: 10px 0; padding: 10px; width: 100%; border-radius: 5px; border: 1px solid #ddd; }
    button { background: #007bff; color: #fff; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    #notification { margin-top: 10px; padding: 10px; border-radius: 5px; display: none; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔐 FHE Calculator (Sepolia)</h1>

    <button onclick="connectWallet()">🔗 Kết nối MetaMask</button>

    <input type="number" id="inputValue" placeholder="Nhập số..." />
    <button onclick="performAdd()">➕ Cộng</button>
    <button onclick="performSubtract()">➖ Trừ</button>

    <h3 id="resultDisplay">Result: (chưa có dữ liệu)</h3>
    <button onclick="refreshResult()">🔄 Refresh Result</button>

    <div id="notification"></div>
  </div>

  <!-- ethers -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- fhevm-js -->
  <script type="module">
    import { Fhevm } from "https://cdn.jsdelivr.net/npm/fhevm-js/+esm";

    let provider, signer, contract, fhe;

    // 📌 Contract info
    const CONTRACT_ADDRESS = "0xe822e0cba6205b85cfaa48b0dd028fc74f17975f"; // sửa lại nếu cần
    const CONTRACT_ABI = [
      "function getResult() view returns (uint256)",
      "function add(uint256,bytes calldata)",
      "function subtract(uint256,bytes calldata)"
    ];

    async function connectWallet() {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        // 🔥 Init FHE context
        fhe = await Fhevm.create();
        showNotification("Ví đã kết nối & FHE ready!", "success");
      } else {
        showNotification("MetaMask chưa cài đặt!", "error");
      }
    }

    // 📌 Encrypt bằng FHE thật
    async function encryptValue(value) {
      if (!fhe) fhe = await Fhevm.create();
      return fhe.encrypt32(value);
    }

    async function performAdd() {
      try {
        const value = parseInt(document.getElementById('inputValue').value);
        if (isNaN(value)) return showNotification("Vui lòng nhập số!", "error");

        const { encrypted, proof } = await encryptValue(value);
        const tx = await contract.add(encrypted, proof);
        await tx.wait();
        showNotification("Gửi giao dịch cộng thành công!", "success");
      } catch (err) {
        console.error(err);
        showNotification("Lỗi khi cộng: " + err.message, "error");
      }
    }

    async function performSubtract() {
      try {
        const value = parseInt(document.getElementById('inputValue').value);
        if (isNaN(value)) return showNotification("Vui lòng nhập số!", "error");

        const { encrypted, proof } = await encryptValue(value);
        const tx = await contract.subtract(encrypted, proof);
        await tx.wait();
        showNotification("Gửi giao dịch trừ thành công!", "success");
      } catch (err) {
        console.error(err);
        showNotification("Lỗi khi trừ: " + err.message, "error");
      }
    }

    async function refreshResult() {
      try {
        if (!contract) return showNotification("Chưa kết nối ví!", "error");

        const encryptedResult = await contract.getResult();
        const decrypted = fhe.decrypt32(encryptedResult); // 🔥 Giải mã
        document.getElementById('resultDisplay').textContent =
          `Decrypted Result: ${decrypted}`;
        showNotification("Kết quả đã giải mã thành công!", "success");
      } catch (err) {
        console.error(err);
        showNotification("Lỗi khi refresh: " + err.message, "error");
      }
    }

    function showNotification(message, type) {
      const note = document.getElementById("notification");
      note.textContent = message;
      note.className = type;
      note.style.display = "block";
      setTimeout(() => note.style.display = "none", 4000);
    }
  </script>
</body>
</html>
