<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHE Auction Bidder</title>
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
    <h1>FHE Auction Bidder</h1>
    <button id="connectWallet">Connect Wallet</button>
    <p id="walletAddress"></p>
    <input type="number" id="bidValue" placeholder="Enter Bid Value (Gwei)" min="0">
    <input type="number" id="depositValue" placeholder="Enter Deposit ETH" min="0.001" step="0.001">
    <button id="placeBid" disabled>Place Bid</button>
    <p id="status"></p>

    <script type="module">
        import { initSDK, createInstance, SepoliaConfig } from 'https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js';

        const CONTRACT_ADDRESS = '0xf1314dff22d14ae4a00e0ea0e05027c1abf985a5';
        const CHAIN_ID = 11155111;
        const RPC_URL = 'https://eth-sepolia.public.blastapi.io';
        const RELAYER_URL = 'https://relayer.testnet.zama.cloud';

        let provider, signer, contract, account, fhevmInstance;

        const FHE_AUCTION_ABI = [
            {
                "inputs": [
                    {"internalType": "externalEuint64", "name": "encryptedBid", "type": "bytes32"},
                    {"internalType": "bytes", "name": "inputProof", "type": "bytes"},
                    {"internalType": "bytes32", "name": "publicKey", "type": "bytes32"},
                    {"internalType": "bytes", "name": "signature", "type": "bytes"}
                ],
                "name": "bid",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            }
        ];

        async function initFhevmSdk() {
            try {
                await initSDK();
                const config = {
                    ...SepoliaConfig,
                    network: RPC_URL,
                    chainId: CHAIN_ID,
                    relayerUrl: RELAYER_URL
                };
                fhevmInstance = await createInstance(config);
                document.getElementById('status').textContent = 'FHE SDK initialized.';
            } catch (error) {
                console.error('FHE SDK Error:', error);
                document.getElementById('status').textContent = `FHE SDK init failed: ${error.message}`;
            }
        }

        // Kết nối ví
        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask not detected!');
                return;
            }

            try {
                // Request accounts
                await window.ethereum.request({ method: 'eth_requestAccounts' });

                // Switch to Sepolia
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: `0x${CHAIN_ID.toString(16)}` }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        alert('Please add Sepolia network to MetaMask');
                        throw new Error('Sepolia network not added');
                    }
                    throw switchError;
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                account = await signer.getAddress();
                document.getElementById('walletAddress').textContent = `Connected: ${account}`;

                contract = new ethers.Contract(CONTRACT_ADDRESS, FHE_AUCTION_ABI, signer);

                await initFhevmSdk();

                document.getElementById('placeBid').disabled = false;
                document.getElementById('status').textContent = 'Ready to bid.';
            } catch (error) {
                console.error('Connection error:', error);
                document.getElementById('status').textContent = `Error: ${error.message}`;
            }
        });

        // Đặt bid
        document.getElementById('placeBid').addEventListener('click', async () => {
            const bidValue = BigInt(document.getElementById('bidValue').value);
            const depositValue = parseFloat(document.getElementById('depositValue').value);

            if (!fhevmInstance) return alert('Init FHE SDK first!');

            try {
                const input = fhevmInstance.createEncryptedInput(CONTRACT_ADDRESS, account);
                input.add64(bidValue);

                const encryptedData = await input.encrypt();

                const encryptedBid = encryptedData.handles[0];
                const inputProof = encryptedData.inputProof;

                const encryptedBidBytes32 = typeof encryptedBid === 'string' && encryptedBid.startsWith('0x') 
                    ? encryptedBid 
                    : ethers.utils.hexlify(encryptedBid);

                const publicKeyToSign = encryptedBidBytes32;

                const domain = {
                    name: 'FHEAuction',
                    version: '1',
                    chainId: CHAIN_ID,
                    verifyingContract: CONTRACT_ADDRESS
                };

                const types = {
                    PublicKey: [{ name: 'key', type: 'bytes32' }]
                };

                const value = { key: publicKeyToSign };

                const signature = await signer._signTypedData(domain, types, value);

                const depositWei = ethers.utils.parseEther(depositValue.toString());

                const tx = await contract.bid(
                    encryptedBidBytes32,
                    inputProof,
                    publicKeyToSign,
                    signature,
                    { value: depositWei, gasLimit: 500000 }
                );

                document.getElementById('status').textContent = `Bid placed! Tx: ${tx.hash}`;
                await tx.wait();
                alert('Bid confirmed!');
            } catch (error) {
                console.error(error);
                document.getElementById('status').textContent = `Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>
