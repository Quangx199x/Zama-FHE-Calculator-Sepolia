<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FHE Auction Demo</title>
  <style>
    body {
      font-family: monospace;
      background: #111;
      color: #eee;
      padding: 20px;
    }
    h1 {
      color: #0ff;
    }
    button {
      background: #222;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 10px;
      margin: 5px;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    input {
      padding: 5px;
      background: #222;
      color: #fff;
      border: 1px solid #555;
    }
    .log-line { margin: 2px 0; }
    .log-info { color: #0ff; }
    .log-confirmed { color: #0f0; }
    .log-failed { color: #f55; }
    .notification { margin: 10px 0; padding: 5px; border-radius: 4px; }
    .notification.success { background: #060; color: #fff; }
    .notification.error { background: #600; color: #fff; }
  </style>
</head>
<body>
  <h1>üîê FHE Auction (Sepolia)</h1>

  <div id="walletStatus">
    <p class="log-line">[STATUS] Wallet not connected.</p>
  </div>

  <button id="connectBtn" onclick="connectWallet()">> CONNECT WALLET</button>

  <div style="margin-top:20px;">
    <label>Bid Amount (ETH): </label>
    <input type="number" id="bidAmount" step="0.01" placeholder="0.1" />
    <button id="bidBtn" onclick="placeBid()" disabled>PLACE BID</button>
  </div>

  <div style="margin-top:20px;">
    <p>Min Deposit: <span id="minDepositValue">-</span></p>
    <p>Lead Bidder: <span id="leadBidder">-</span></p>
    <p>Current Bid: <span id="currentBid">-</span></p>
    <p>Auction End: <span id="auctionTimer">-</span></p>
  </div>

  <div id="notifications"></div>

  <pre id="logOutput"></pre>

  <!-- Ethers.js v6 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
  <!-- Zama FHE Relayer SDK -->
  <script src="https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.umd.cjs"></script>

  <script>
    // === CONFIG ===
    const SEPOLIA_CHAIN_ID = 11155111;
    const CONTRACT_ADDRESS = "0x4140e9d65f5161c15843bd69413b691388230341"; // ‚ö†Ô∏è Thay ƒë·ªãa ch·ªâ contract th·∫≠t
    const FHE_AUCTION_ABI = [{"inputs":[{"internalType":"uint256","name":"_durationInSeconds","type":"uint256"},{"internalType":"uint256","name":"_minDeposit","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"HandlesAlreadySavedForRequestID","type":"error"},{"inputs":[],"name":"InvalidKMSSignatures","type":"error"},{"inputs":[],"name":"InvalidShortString","type":"error"},{"inputs":[],"name":"NoHandleFoundForRequestID","type":"error"},{"inputs":[],"name":"ReentrancyGuardReentrantCall","type":"error"},{"inputs":[{"internalType":"string","name":"str","type":"string"}],"name":"StringTooLong","type":"error"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"finalDeposit","type":"uint256"}],"name":"AuctionFinished","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":false,"internalType":"uint256","name":"depositAmount","type":"uint256"},{"indexed":false,"internalType":"bool","name":"isNewLeader","type":"bool"}],"name":"BidReceived","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"BidderWithdrew","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"requestID","type":"uint256"}],"name":"DecryptionFulfilled","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"requestId","type":"uint256"}],"name":"DecryptionRequested","type":"event"},{"anonymous":false,"inputs":[],"name":"EIP712DomainChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RefundIssued","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[],"name":"auctionEndTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auctionFinalized","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"externalEuint64","name":"encryptedBid","type":"bytes32"},{"internalType":"bytes","name":"proof","type":"bytes"}],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"currentLeadBidder","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentLeadDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"eip712Domain","outputs":[{"internalType":"bytes1","name":"fields","type":"bytes1"},{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"version","type":"string"},{"internalType":"uint256","name":"chainId","type":"uint256"},{"internalType":"address","name":"verifyingContract","type":"address"},{"internalType":"bytes32","name":"salt","type":"bytes32"},{"internalType":"uint256[]","name":"extensions","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"emergencyCancel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"finalizeAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAuctionEndTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCurrentLeadBidder","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getCurrentLeadDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMinBidDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isAuctionFinalized","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"bidder","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"manualRefund","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"minBidDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"requestId","type":"uint256"},{"internalType":"bytes","name":"cleartexts","type":"bytes"},{"internalType":"bytes","name":"decryptionProof","type":"bytes"}],"name":"onDecryptionCallback","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"protocolId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"address","name":"bidder","type":"address"}],"name":"requestDecryptBidderBid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"requestDecryptMaxBid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newLeader","type":"address"},{"internalType":"uint256","name":"newDeposit","type":"uint256"}],"name":"updateLeaderAfterReveal","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"winningBid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawWinnings","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}]; // ‚ö†Ô∏è Import ABI JSON c·ªßa b·∫°n

    let provider, signer, account, fheAuctionContract, fhevmInstance;
    let minDepositWei = 0n;
    let auctionEndTime = 0;
    let auctionFinalized = false;

    // --- Logger & Notifications ---
    function logMessage(msg, type='info') {
      const log = document.getElementById('logOutput');
      const line = document.createElement('div');
      line.className = 'log-line log-' + type;
      line.textContent = msg;
      log.appendChild(line);
      log.scrollTop = log.scrollHeight;
    }
    function showNotification(msg, type='info') {
      const box = document.getElementById('notifications');
      const note = document.createElement('div');
      note.className = 'notification ' + (type==='success'?'success':'error');
      note.textContent = msg;
      box.appendChild(note);
      setTimeout(()=>note.remove(), 4000);
    }

    // --- Wallet Connection (Ethers v6) ---
    async function connectWallet() {
      if (typeof window.ethereum === 'undefined') {
        showNotification('MetaMask not detected.', 'error');
        return;
      }
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: `0x${SEPOLIA_CHAIN_ID.toString(16)}` }],
        });

        provider = new ethers.BrowserProvider(window.ethereum);
        const network = await provider.getNetwork();
        if (Number(network.chainId) !== SEPOLIA_CHAIN_ID) {
          throw new Error("Wrong network. Switch to Sepolia.");
        }

        signer = await provider.getSigner();
        account = await signer.getAddress();

        fhevmInstance = await initFhevmSdk(provider);
        if (!fhevmInstance) throw new Error("FHE SDK init failed.");

        fheAuctionContract = new ethers.Contract(CONTRACT_ADDRESS, FHE_AUCTION_ABI, signer);

        await getAuctionState();

        document.getElementById('walletStatus').innerHTML = `
          <p class="log-line log-confirmed">[STATUS] Wallet Connected</p>
          <p class="log-line">[ADDRESS] ${account.substring(0,10)}...</p>
          <p class="log-line">[NETWORK] Sepolia</p>
        `;
        document.getElementById('connectBtn').textContent = '> CONNECTED';
        document.getElementById('connectBtn').disabled = true;
        document.getElementById('bidBtn').disabled = false;

        showNotification('Connected to Sepolia ‚úÖ', 'success');
        logMessage('[SUCCESS] Wallet ready.', 'confirmed');
      } catch (err) {
        console.error(err);
        showNotification('Connection Failed: ' + err.message, 'error');
        logMessage('[ERROR] ' + err.message, 'failed');
      }
    }

    // --- Place Bid ---
    async function placeBid() {
      let bidAmountETH = parseFloat(document.getElementById('bidAmount').value);
      if (!fheAuctionContract || !account || !fhevmInstance) {
        showNotification('Wallet/SDK not ready.', 'error');
        return;
      }
      if (Date.now() > auctionEndTime) {
        showNotification('Auction ended.', 'error');
        return;
      }
      if (isNaN(bidAmountETH) || bidAmountETH <= 0) {
        showNotification('Invalid amount.', 'error');
        return;
      }
      const bidAmountWei = ethers.parseEther(bidAmountETH.toString());
      if (bidAmountWei < minDepositWei) {
        showNotification(`Deposit must ‚â• ${ethers.formatEther(minDepositWei)} ETH`, 'error');
        return;
      }
      logMessage(`[BID] ${bidAmountETH} ETH submitted.`, 'info');
      showNotification(`Bid ${bidAmountETH} ETH submitted.`, 'success');
      // ‚ö†Ô∏è TODO: G·ªçi h√†m FHE m√£ h√≥a & g·ª≠i transaction
    }

    // --- Load State ---
    async function getAuctionState() {
      try {
        const [minDeposit, endTime, leadBidder, finalized] = await Promise.all([
          fheAuctionContract.getMinBidDeposit(),
          fheAuctionContract.getAuctionEndTime(),
          fheAuctionContract.getCurrentLeadBidder(),
          fheAuctionContract.isAuctionFinalized()
        ]);
        minDepositWei = minDeposit;
        document.getElementById('minDepositValue').textContent = `${ethers.formatEther(minDeposit)} ETH`;
        auctionEndTime = Number(endTime) * 1000;
        document.getElementById('leadBidder').textContent = leadBidder===ethers.ZeroAddress?'0x0...':leadBidder.substring(0,6)+'...';
        auctionFinalized = finalized;
      } catch (err) {
        console.error(err);
        logMessage('[ERROR] load state: ' + err.message, 'failed');
      }
    }

    // --- Timer ---
    setInterval(()=>{
      if (auctionEndTime>0) {
        let t = auctionEndTime - Date.now();
        if (t<=0) document.getElementById('auctionTimer').textContent = "ENDED";
        else document.getElementById('auctionTimer').textContent = (t/1000).toFixed(0)+'s left';
      }
    },1000);

    // Dummy init FHE SDK
    async function initFhevmSdk(provider) {
      try {
        logMessage('[FHE SDK] Initializing...', 'info');
        return { ok:true }; // ‚ö†Ô∏è Thay b·∫±ng g·ªçi th·ª±c t·∫ø relayer-sdk
      } catch (err) {
        console.error(err);
        return null;
      }
    }
  </script>
</body>
</html>
